<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Job Config</title>
    <style>
        .wizard-step { display: none; }
        .wizard-step.active { display: block; }
        input, select { display: block; margin: 10px 0; width: 300px; }
        button { margin: 5px; padding: 8px 16px; }
    </style>
</head>
<body>
    <h1>Job Configuration</h1>
    
    <div class="wizard-step active" data-step="1">
        <h2>Step 1: Job Name</h2>
        <button onclick="useDefaults()">Use Defaults</button>
        <label>Job Name: <input type="text" id="jobName" value="ollama_inference_job"></label>
    </div>

    <div class="wizard-step" data-step="2">
        <h2>Step 2: Infrastructure</h2>
        <label>Partition: <select id="partition"><option value="cpu">CPU</option><option value="gpu" selected>GPU</option></select></label>
        <label>Account: <input type="text" id="account" value="p200981"></label>
        <label>Nodes: <input type="number" id="nodes" value="1" min="1"></label>
        <label>Memory (GB): <input type="number" id="memory" value="64" min="1"></label>
        <label>Time: <input type="text" id="time" value="00:05:00"></label>
    </div>

    <div class="wizard-step" data-step="3">
        <h2>Step 3: Service</h2>
        <label>Type: <select id="serviceType"><option value="inference" selected>Inference</option><option value="training">Training</option></select></label>
        <label>Model: <input type="text" id="model" value="llama2"></label>
        <label>Precision: <select id="precision"><option value="fp16" selected>FP16</option><option value="fp32">FP32</option><option value="int8">INT8</option></select></label>
        <label>Clients: <input type="number" id="nClients" value="2" min="1"></label>
        <label>Requests: <input type="number" id="nRequests" value="5" min="1"></label>
    </div>

    <div class="wizard-step" data-step="4">
        <h2>Step 4: Review</h2>
        <pre id="jsonOutput"></pre>
        <button onclick="copyJSON()">Copy</button>
        <button onclick="callBenchmark()">Start Benchmark</button>
    </div>

    <div>
        <button id="prevBtn" onclick="changeStep(-1)" style="display:none">Previous</button>
        <button id="nextBtn" onclick="changeStep(1)">Next</button>
    </div>

<script>
let currentStep = 1;
const totalSteps = 4;

const defaults = {
    jobName: "ollama_inference_job", partition: "gpu", account: "p200981",
    nodes: 1, memory: 64, time: "00:05:00", serviceType: "inference",
    model: "llama2", precision: "fp16", nClients: 2, nRequests: 5
};

async function useDefaults() {
    Object.keys(defaults).forEach(key => {
        const el = document.getElementById(key);
        if (el) el.value = defaults[key];
    });
    await callBenchmark(generateConfigObject());
    alert('✓ Defaults saved to recipe.json!');
}

function generateConfigObject() {
    return {
        job: {
            name: document.getElementById('jobName').value,
            infrastructure: {
                partition: document.getElementById('partition').value,
                account: document.getElementById('account').value,
                nodes: parseInt(document.getElementById('nodes').value),
                mem_gb: parseInt(document.getElementById('memory').value),
                time: document.getElementById('time').value
            },
            service: {
                type: document.getElementById('serviceType').value,
                model: document.getElementById('model').value,
                precision: document.getElementById('precision').value,
                n_clients: parseInt(document.getElementById('nClients').value),
                n_requests_per_client: parseInt(document.getElementById('nRequests').value)
            }
        }
    };
}

async function callBenchmark(config) {
    if(config === undefined) config = generateConfigObject();
    try {
        console.log('calling callBenchmark');
        const response = await fetch('/startbenchmark', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
        });
        const result = await response.json();
        if (!result.success) alert('Error: ' + result.error);
        if(result.success) alert("jobId: "+ result.jobId+" Correctly submitted!");
        return result;
    } catch (error) {
        alert('Network error: ' + error.message);
        return { success: false };
    }
}

async function changeStep(direction) {
    const newStep = currentStep + direction;
    if (newStep < 1 || newStep > totalSteps) return;
    
    if (currentStep === totalSteps && direction === 1) {
        const result = await callBenchmark(generateConfigObject());
        alert(result.success ? `✓ Saved to: ${result.path}` : 'Error: ' + result.error);
        return;
    }
    
    document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.remove('active');
    currentStep = newStep;
    document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.add('active');
    
    document.getElementById('prevBtn').style.display = currentStep === 1 ? 'none' : 'block';
    document.getElementById('nextBtn').textContent = 'Next';
    document.getElementById('nextBtn').style.display = currentStep === totalSteps ? 'none' : 'block';

    
    if (currentStep === totalSteps) showJSON();
}

function showJSON() {
    document.getElementById('jsonOutput').textContent = JSON.stringify(generateConfigObject(), null, 2);
}

function copyJSON() {
    navigator.clipboard.writeText(document.getElementById('jsonOutput').textContent);
    alert('✓ Copied!');
}

</script>

</body>
</html>
